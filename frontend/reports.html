<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Reportes - HealthTrack Systems</title>
  <link rel="stylesheet" href="css/styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
  <div class="app-container">
    <!-- Sidebar -->
    <aside class="sidebar">
      <div class="sidebar-header">
        <img src="img/healthtrack-logo.png" alt="HealthTrack" class="logo-img">
      </div>
        <nav class="sidebar-nav">
          <a href="dashboard.html" class="nav-item "><span class="icon"><i class="fas fa-chart-line"></i></span><span data-i18n="dashboard">Dashboard</span></a>
          <a href="pos.html" class="nav-item"><span class="icon"><i class="fas fa-cash-register"></i></span><span data-i18n="pos">Punto de Venta</span></a>
          <a href="inventory.html" class="nav-item"><span class="icon"><i class="fas fa-boxes"></i></span><span data-i18n="inventory">Inventario</span></a>
          <a href="patients.html" class="nav-item"><span class="icon"><i class="fas fa-users"></i></span><span data-i18n="patients">Pacientes</span></a>
          <a href="doctors.html" class="nav-item"><span class="nav-icon"><i class="fas fa-user-md"></i></span><span data-i18n="doctors">Doctores</span></a>
          <a href="invoices.html" class="nav-item"><span class="nav-icon"><i class="fas fa-file-invoice"></i></span><span data-i18n="invoices">Facturas</span></a>
          <a href="reports.html" class="nav-item active"><span class="nav-icon"><i class="fas fa-chart-bar"></i></span><span data-i18n="reports">Reportes</span></a>
          <a href="users.html" class="nav-item" id="usersNavItem" class="d-none"><span class="icon"><i class="fas fa-user-cog"></i></span><span data-i18n="users">Usuarios</span></a>
        </nav>
            <!-- Language Toggle -->
            <div class="language-toggle">
                <div class="language-toggle-label">
                    <span>Language</span>
                    <span id="langLabel">ES</span>
                </div>
                <label class="toggle-switch">
                    <input type="checkbox" id="langToggle">
                    <span class="toggle-slider"></span>
                </label>
                <div class="language-labels">
                    <span id="esLabel">Espanol</span>
                    <span id="enLabel">English</span>
                </div>
            </div>

      <div class="sidebar-footer">
        <div class="user-info">
          <div class="user-avatar" id="userAvatar">U</div>
          <div class="user-details">
            <div class="user-name" id="userName" data-i18n="user">Usuario</div>
            <div class="user-role" id="userRole" data-i18n="role">Rol</div>
          </div>
        </div>
        <button class="btn btn-danger btn-block btn-sm" id="logoutBtn" data-i18n="logout">Cerrar Sesion</button>
      </div>
    </aside>

    <!-- Main -->
    <main class="main-content">
      <div class="top-bar">
        <h1 class="page-title"><i class="fas fa-circle"></i> Reportes</h1>
        <div class="top-bar-actions">
          <span id="currentDate"></span>
        </div>
      </div>

      <div class="content">
        <!-- Filters -->
        <div class="card">
          <div class="card-header">
            <h3 class="card-title"><i class="fas fa-circle"></i> Filtros</h3>
          </div>
          <div class="card-body">
            <div class="report-filters">
              <div class="form-group">
                <label>Fecha Inicio</label>
                <input type="date" id="filterStartDate" class="form-control">
              </div>
              <div class="form-group">
                <label>Fecha Fin</label>
                <input type="date" id="filterEndDate" class="form-control">
              </div>

              <div class="form-group">
                <label>Rangos rNpidos</label>
                <div class="d-flex gap-10 flex-wrap">
                  <button class="btn btn-secondary btn-sm" id="btnLast7">Nšltimos 7 dias</button>
                  <button class="btn btn-secondary btn-sm" id="btnLast30">Nšltimos 30 dias</button>
                  <button class="btn btn-secondary btn-sm" id="btnThisMonth">Este mes</button>
                </div>
              </div>

              <div class="form-group" class="d-flex gap-10 align-items-end">
                <button class="btn btn-primary" id="btnApply">Aplicar</button>
                <button class="btn btn-secondary" id="btnClear">Limpiar</button>
              </div>
            </div>
          </div>
        </div>

        <!-- KPI Cards -->
        <div class="stats-container" class="mt-15">
          <div class="stat-card">
            <div class="stat-icon">&#9642;</div>
            <div class="stat-content">
              <div class="stat-label">Facturas</div>
              <div class="stat-value" id="kpiInvoices">0</div>
            </div>
          </div>
          <div class="stat-card">
            <div class="stat-icon">&#9642;</div>
            <div class="stat-content">
              <div class="stat-label">Activas</div>
              <div class="stat-value" id="kpiActive">0</div>
            </div>
          </div>
          <div class="stat-card">
            <div class="stat-icon">&#9642;</div>
            <div class="stat-content">
              <div class="stat-label">Anuladas</div>
              <div class="stat-value" id="kpiVoided">0</div>
            </div>
          </div>
          <div class="stat-card">
            <div class="stat-icon">&#9642;</div>
            <div class="stat-content">
              <div class="stat-label">Ventas Brutas</div>
              <div class="stat-value" id="kpiGross">&#9642;</div>
            </div>
          </div>
          <div class="stat-card">
            <div class="stat-icon">&#9642;</div>
            <div class="stat-content">
              <div class="stat-label">Reembolsos</div>
              <div class="stat-value" id="kpiRefunds">&#9642;</div>
              <div class="stat-subvalue" id="kpiRefundBreakdown" class="text-muted text-sm">0 Full / 0 Partial</div>
            </div>
          </div>
          <div class="stat-card">
            <div class="stat-icon">&#9642;</div>
            <div class="stat-content">
              <div class="stat-label">Neto</div>
              <div class="stat-value" id="kpiNet">&#9642;</div>
            </div>
          </div>
        </div>

        <!-- Sales trend -->
        <div class="card" class="mt-15">
          <div class="card-header" class="card-header-with-actions">
            <h3 class="card-title"><i class="fas fa-circle"></i> Tendencia de Ventas (por dia)</h3>
            <button class="btn btn-secondary btn-sm" id="btnExportSalesTrend">Exportar CSV</button>
          </div>
          <div class="card-body" class="overflow-x-auto">
            <table class="table" id="tblSalesTrend">
              <thead>
                <tr>
                  <th>Dia</th>
                  <th>Facturas</th>
                  <th>Anuladas</th>
                  <th>Ventas Brutas</th>
                </tr>
              </thead>
              <tbody id="salesTrendBody"></tbody>
            </table>
          </div>
        </div>

        <!-- Top products -->
        <div class="card" class="mt-15">
          <div class="card-header" class="card-header-with-actions">
            <h3 class="card-title"><i class="fas fa-circle"></i> Top Productos</h3>
            <button class="btn btn-secondary btn-sm" id="btnExportTopProducts">Exportar CSV</button>
          </div>
          <div class="card-body" class="overflow-x-auto">
            <table class="table" id="tblTopProducts">
              <thead>
                <tr>
                  <th>Producto</th>
                  <th>Cantidad</th>
                  <th>Ingresos</th>
                </tr>
              </thead>
              <tbody id="topProductsBody"></tbody>
            </table>
          </div>
        </div>

        <!-- Refund summary -->
        <div class="card" class="mt-15">
          <div class="card-header" class="card-header-with-actions">
            <h3 class="card-title"><i class="fas fa-circle"></i> Reembolsos por metodo</h3>
            <button class="btn btn-secondary btn-sm" id="btnExportRefunds">Exportar CSV</button>
          </div>
          <div class="card-body" class="overflow-x-auto">
            <table class="table" id="tblRefunds">
              <thead>
                <tr>
                  <th>Metodo</th>
                  <th># Reembolsos</th>
                  <th>Total</th>
                  <th>Full</th>
                  <th>Partial</th>
                </tr>
              </thead>
              <tbody id="refundsBody"></tbody>
            </table>
          </div>
        </div>

        <!-- Inventory movements -->
        <div class="card" class="mt-15">
          <div class="card-header" class="card-header-with-actions">
            <h3 class="card-title"><i class="fas fa-circle"></i> Movimientos de Inventario</h3>
            <button class="btn btn-secondary btn-sm" id="btnExportMovements">Exportar CSV</button>
          </div>
          <div class="card-body" class="overflow-x-auto">
            <table class="table" id="tblMovements">
              <thead>
                <tr>
                  <th>Tipo</th>
                  <th>Movimientos</th>
                  <th>Cantidad Total</th>
                </tr>
              </thead>
              <tbody id="movementsBody"></tbody>
            </table>
          </div>
        </div>

      </div>
    </main>
  </div>

  <script src="js/utils.js"></script>
  <script src="js/reports.js"></script>
  <script>
    // Show Users menu item only for admins
    document.addEventListener('DOMContentLoaded', async () => {
      const response = await fetch('/api/auth/session');
      const data = await response.json();
      if (data.loggedIn && data.user && data.user.roleName === 'Administrator') {
        const usersNavItem = document.getElementById('usersNavItem');
        if (usersNavItem) usersNavItem.classList.remove('d-none');
      }
    });
  </script>
    <script src="js/language.js"></script>
</body>
</html>